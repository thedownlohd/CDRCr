---
title: "HW 10"
author: "Kendall Loh"
date: "12/3/2018"
output:
  html_document:
    keep_md: no
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# QMSS G5072 Homework 10

## Setting up libraries

```{r}

library(odbc)
library(DBI)
library(dbplyr)
library(magrittr)
library(dbplyr)
library(dplyr)
```




## Setting up Connection
```{r}
# Connection
witch_con <- dbConnect(RMySQL::MySQL(),
                 user='student', 
                 password='mds-is-fun',
                 dbname='witchcraft', 
                 host='tbrambor.cczjcoy6i2jn.us-east-1.rds.amazonaws.com',
                 port = 3306)
```



## 1. Getting to know the data

### 1a. Show a list of the tables included in the database.

```{sql, connection="witch_con"}

SHOW TABLES

```

### 1b. Display the column names for the table accused.


```{sql, connection="witch_con"}

DESCRIBE accused

```

### 1c. How many people are included in the accused table?

```{sql, connection="witch_con"}
SELECT COUNT(lastname)
FROM accused

```


### 1d. Display the columns firstname, sex, and age for 5 cases in the accused table.

```{sql, connection="witch_con"}
SELECT firstname, sex, age
FROM accused
LIMIT 5

```


### 1e. Looks like the age is missing for some observations. Count the number of nonmissing values for age in the data.

```{sql, connection="witch_con"}
SELECT COUNT(age)
FROM accused
```

### 1f. how a list of unique occupations.

```{sql, connection="witch_con"}
SELECT DISTINCT(occupation)
FROM accused
```

## 2. Seeing the Devil

### 2a. Let’s look at some appearances of the devil in the devilappearance table.

```{sql, connection="witch_con"}

DESCRIBE devilappearance

```


### 2b. List the unique devil_types in the data.
```{sql, connection="witch_con"}

SELECT DISTINCT(devil_type)
FROM devilappearance

```

### 2c. There is also a little description of the type of the devil sighting in the devil_text column. How many of the sightings mention the word “black” in the description?


```{sql, connection="witch_con"}
SELECT COUNT(*)
FROM devilappearance
WHERE devil_text LIKE '%black%'

```

### 2d. What proportion of the devils (in devil_type) are male?


```{sql, connection="witch_con"}

SELECT
 (SUM(devil_type = 'MALE')/COUNT(*)) * 100 as Proportion
FROM devilappearance

```


## 3. The trial
### Let’s take a look at the information on the trial.

```{sql, connection="witch_con"}

DESCRIBE trial
```

### 3a. What are the average and maximum numbers of male and female accusers?
```{sql, connection="witch_con"}

SELECT AVG (female_accusers)
FROM trial

```
```{sql connection="witch_con"}

SELECT MAX(female_accusers)
FROM trial

```

```{sql, connection="witch_con"}

SELECT AVG (male_accusers)
FROM trial

```

```{sql connection="witch_con"}

SELECT MAX(male_accusers)
FROM trial

```



### 3b.  Count the number of sentences by sentence type. List them in a table (in descending order), excluding missing values. Rename the column headings to something sensible.

```{sql connection="witch_con"}

SELECT sentence AS "Sentence Type", COUNT(*) AS "Sentence Volume"
FROM trial
GROUP BY sentence 
ORDER BY COUNT(*) DESC

```

### 3c. Do the number of accusers matter for the verdict? Compare the average number of accusers by the type of verdict. Again make sure the table is sorted and the headings make sense.


```{sql connection="witch_con"}

SELECT verdict AS "Verdict", AVG(female_accusers) AS "Mean Number Female Accusers", AVG(male_accusers) AS "Mean Number of Male Accusers"
FROM trial
GROUP BY verdict 
ORDER BY AVG(female_accusers) DESC

```





## 4. Tortured Truth (Bonus)
### Note: This part is optional. We spent little time on joins in lecture, so I encourage you to try it but feel free to skip.

### Left join the trial and confession tables. For what share of trials does the database record confessions? Create a results table with the number of all trials, the number of confessions, and the share of trials with confessions recorded.

```{sql, connection = witch_con}
SHOW TABLES 

```

```{sql, connection = witch_con}
DESCRIBE trial

```



```{sql, connection = witch_con}

SELECT
  (COUNT(trialid)) AS "Trial Count",
  (COUNT(confessionid)) AS "Confession Count",
  (COUNT(confessionid)/COUNT(trialid)) * 100 as Proportion
FROM trial
LEFT JOIN confession
ON trial.trialref=confession.trialref

```


### Only a small number of trials have records of torture. Is there a higher share of confessions among trials with records of torture than trials without such record? Hint: You will need to merge on the confession table.

110 tortured
3211 trials
941 confessions





